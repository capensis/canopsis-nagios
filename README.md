# Nagios or Icinga Event broker for Canopsis #

## Requirements ##

Debian like (Debian, Ubuntu ...):

    apt-get install build-essential git-core


Redhat like (Centos ..):

    yum groupinstall "Development Tools"
    yum install kernel-devel kernel-headers git-core


## Download and Build ##

via git:

    git clone https://github.com/capensis/canopsis-nagios.git
    cd canopsis-nagios
    make

via HTTP:

    wget --no-check-certificate  https://github.com/capensis/canopsis-nagios/tarball/master -O canopsis-nagios.tgz
    tar xfz canopsis-nagios.tgz
    cd capensis-*
    make

## Install ##

Copy NEB in your Nagios/Icinga installation:

    sudo cp src/neb2amqp.o /usr/local/nagios/bin/


## Configure ##

Edit your Nagios/Icinga configuration (nagios.cfg):

    event_broker_options=-1
    broker_module=/usr/local/nagios/bin/neb2amqp.o name=Central host=localhost

Options:

    host =          AMQP Server (127.0.0.1)
    port =          AMQP Port (5672)
    userid =        AMQP login (guest)
    password =      AMQP password (guest)
    virtual_host =  AMQP Virtual host (canopsis)
    exchange_name = AMQP Exchange (canopsis.events)
    name =          Poller name (Central)
    connector =     Connector name (nagios) (you can type "icinga" for icinga)
    max_size =      Maximum message size to send to the AMQP bus (8192)
    cache_file =    File in which faulty messages are stored (/usr/local/nagios/var/canopsis.cache)
                    (note: if we cannot read/create the file, the cache will
                    only run in memory)
    cache_size =    Number of messages to store in cache (500)
    autoflush =     Delay in seconds between two automatic flush of the cache into 'cache_file'.
                    If < 0 disable autoflush (note: the cache will always be stored when the module
                    is unloaded). If = 0 cache every time (this is not recommended as it may consumes
                    lot of I/O) (default: 60)

If nagios.cfg is generated by other program, you can try to add in your nagios init script:

    CPS_NEB=$prefix/bin/neb2amqp.o
    CPS_NAME=$(hostname -s)
    CPS_SERVER="odeon.root.local"
    if [ -e $CPS_NEB ]; then
            grep "$CPS_NEB" $NagiosCfgFile &> /dev/null
            if [ $? -eq 1 ]; then
                echo "Add NEB: '$CPS_NEB' to configuration file '$NagiosCfgFile'"
                echo "broker_module=$CPS_NEB name=$CPS_NAME host=$CPS_SERVER" >> $NagiosCfgFile
            fi
    fi
